{% extends "base.html" %}

{% block title %}Edit Profile - Digital Club{% endblock %}

{% block extra_head %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .edit-profile-page {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .profile-form {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .edit-profile-page { padding: 1.25rem 0; }
        .profile-form { padding: 1.25rem; }
        .section-title { font-size: 1.05rem; }
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .section-title {
        color: var(--primary-color);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.5rem;
        font-size: 1.3rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .form-control {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 0.75rem;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.2);
        outline: none;
        background: rgba(0, 0, 0, 0.4);
    }
    
    .form-control::placeholder {
        color: var(--text-muted);
    }
    
    .form-select {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 0.75rem;
        width: 100%;
    }

    /* Force visible text in inputs on this page */
    .profile-form .form-control,
    .profile-form .form-select,
    .profile-form textarea {
        color: var(--text-primary) !important;
        -webkit-text-fill-color: var(--text-primary);
        background-color: rgba(0, 0, 0, 0.35) !important;
        caret-color: var(--primary-color);
    }

    .profile-form .form-control::placeholder,
    .profile-form textarea::placeholder {
        color: var(--text-muted) !important;
        opacity: 1;
    }

    .profile-form .form-control:-webkit-autofill,
    .profile-form .form-select:-webkit-autofill,
    .profile-form textarea:-webkit-autofill {
        -webkit-text-fill-color: var(--text-primary) !important;
        box-shadow: 0 0 0px 1000px rgba(0, 0, 0, 0.35) inset;
        transition: background-color 99999s ease-in-out 0s;
    }
    
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.2);
        outline: none;
    }
    
    .btn-primary {
        background: var(--primary-color);
        border: 1px solid var(--primary-color);
        color: var(--bg-primary);
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        border-color: var(--primary-color);
        color: var(--primary-color) !important;
        background-color: rgba(0, 255, 255, 0.12) !important;
    }

    /* Ensure cancel/back buttons stay readable on hover/focus */
    .profile-form .btn.btn-secondary,
    .profile-form a.btn.btn-secondary {
        color: var(--text-primary) !important;
        background-color: transparent !important;
        border-color: var(--border-color) !important;
    }
    .profile-form .btn.btn-secondary:hover,
    .profile-form .btn.btn-secondary:focus,
    .profile-form a.btn.btn-secondary:hover,
    .profile-form a.btn.btn-secondary:focus {
        color: var(--bg-primary) !important;
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        text-decoration: none;
    }
    
    .profile-image-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        color: var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .file-input-wrapper:hover {
        background: rgba(0, 255, 255, 0.2);
    }
    
    .file-input-wrapper input[type="file"] {
        position: absolute;
        left: -9999px;
    }
    
    .projects-json {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        color: var(--text-primary);
        min-height: 200px;
    }
    
    .help-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }
    
    /* Cropper Modal Styles */
    .crop-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        overflow: auto;
    }
    
    .crop-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .crop-container {
        background: var(--bg-secondary);
        border: 2px solid var(--primary-color);
        border-radius: 15px;
        padding: 2rem;
        max-width: 90%;
        max-height: 90vh;
        overflow: auto;
    }
    
    .crop-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .crop-header h3 {
        color: var(--primary-color);
        margin: 0;
    }
    
    .crop-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.3s;
    }
    
    .crop-close:hover {
        color: var(--primary-color);
    }
    
    .crop-preview-container {
        max-width: 600px;
        max-height: 400px;
        margin: 0 auto 1.5rem;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .crop-preview-container img {
        max-width: 100%;
        display: block;
    }
    
    .crop-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }
    
    .crop-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.3);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .crop-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .crop-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    
    .crop-actions .btn-primary {
        background: var(--primary-color);
        border: none;
        padding: 0.75rem 2rem;
    }
    
    .crop-actions .btn-secondary {
        background: transparent;
        border: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-page">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="profile-form" data-aos="fade-up">
                    <div class="text-center mb-4">
                        <h2 class="text-primary mb-2">Edit Profile</h2>
                        <p class="text-secondary">Update your personal information and preferences</p>
                    </div>
                    
                    <form method="POST" enctype="multipart/form-data">
                        <!-- Profile Image Section -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-camera"></i>
                                Profile Image
                            </h4>
                            
                            <div class="text-center mb-3">
                                {% if member and member.profile_image %}
                                    <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_image) }}" 
                                         alt="Profile Preview" class="profile-image-preview" id="image-preview" loading="lazy" decoding="async">
                                {% else %}
                                    <div class="profile-image-preview d-flex align-items-center justify-content-center" 
                                         style="background: var(--primary-color); color: var(--bg-primary); font-size: 3rem;" id="image-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group text-center">
                                <label class="file-input-wrapper">
                                    <i class="fas fa-upload"></i> Choose Image
                                    <input type="file" name="profile_image" id="profile_image" accept="image/*" onchange="previewImage(this)">
                                </label>
                                <div class="help-text">PNG, JPG, JPEG, or GIF - Any size accepted (will be optimized automatically)</div>
                            </div>
                        </div>
                        
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-user"></i>
                                Basic Information
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="full_name" class="form-label">Full Name *</label>
                                        <input type="text" class="form-control" id="full_name" name="full_name" autocomplete="name"
                                               value="{{ member.full_name if member else '' }}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="title" class="form-label">Professional Title</label>
                                        <input type="text" class="form-control" id="title" name="title" autocomplete="organization-title"
                                               value="{{ member.title if member else '' }}" 
                                               placeholder="e.g., Software Developer, Data Scientist">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="bio" class="form-label">Bio</label>
                                <textarea class="form-control" id="bio" name="bio" rows="4" spellcheck="true"
                                          placeholder="Tell us about yourself...">{{ member.bio if member else '' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- Academic Information -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-graduation-cap"></i>
                                Academic Information
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course" class="form-label">Course</label>
                                        <input type="text" class="form-control" id="course" name="course"
                                               value="{{ member.course if member else '' }}" 
                                               placeholder="e.g., Computer Science, Information Technology">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="year" class="form-label">Year</label>
                                        <input type="text" class="form-control" id="year" name="year"
                                               value="{{ member.year if member else '' }}" 
                                               placeholder="e.g., Year 2, Graduate">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="student" {% if member and member.status == 'student' %}selected{% endif %}>Student</option>
                                    <option value="alumni" {% if member and member.status == 'alumni' %}selected{% endif %}>Alumni</option>
                                </select>
                                <div class="help-text">Change your status from student to alumni when you graduate</div>
                            </div>
                        </div>
                        
                        <!-- Contact Information -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-address-book"></i>
                                Contact Information
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" name="phone" autocomplete="tel" inputmode="tel"
                                               value="{{ member.phone if member else '' }}" 
                                               placeholder="+255 XXX XXX XXX">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="areas_of_interest" class="form-label">Areas of Interest</label>
                                        <input type="text" class="form-control" id="areas_of_interest" name="areas_of_interest"
                                               value="{{ member.areas_of_interest if member else '' }}" 
                                               placeholder="e.g., Web Development, AI, Data Science (comma-separated)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Social Links -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-share-alt"></i>
                                Social Links (Optional)
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="github" class="form-label">GitHub Profile</label>
                                        <input type="text" class="form-control" id="github" name="github" autocomplete="url"
                                               value="{{ member.github if member else '' }}" 
                                               placeholder="https://github.com/username">
                                        <div class="help-text">Optional: Your GitHub profile URL</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="linkedin" class="form-label">LinkedIn Profile</label>
                                        <input type="text" class="form-control" id="linkedin" name="linkedin" autocomplete="url"
                                               value="{{ member.linkedin if member else '' }}" 
                                               placeholder="https://linkedin.com/in/username">
                                        <div class="help-text">Optional: Your LinkedIn profile URL</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personal Projects -->
                        <!-- <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-project-diagram"></i>
                                Personal Projects
                            </h4>
                            
                            <div class="form-group">
                                <label for="projects" class="form-label">Projects (JSON Format)</label>
                                <textarea class="projects-json" id="projects" name="projects" rows="8" 
                                          placeholder='[
  {
    "name": "Project Name",
    "description": "Project description",
    "technologies": ["React", "Node.js", "MongoDB"],
    "github_url": "https://github.com/username/project",
    "demo_url": "https://project-demo.com"
  }
]'>{{ member.projects_json if member and member.projects_json else '' }}</textarea>
                                <div class="help-text">
                                    Enter your projects in JSON format. Each project should have name, description, technologies, and optional URLs.
                                </div>
                            </div>
                        </div> -->
                        
                        <!-- Form Actions -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary me-3">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <a href="{{ url_for('member.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Crop Modal -->
<div id="cropModal" class="crop-modal">
    <div class="crop-container">
        <div class="crop-header">
            <h3><i class="fas fa-crop"></i> Crop Profile Image</h3>
            <button class="crop-close" onclick="closeCropModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="crop-preview-container">
            <img id="cropImage" src="" alt="Crop Preview">
        </div>
        
        <div class="crop-controls">
            <button class="crop-btn" onclick="cropper.zoom(0.1)" title="Zoom In">
                <i class="fas fa-search-plus"></i> Zoom In
            </button>
            <button class="crop-btn" onclick="cropper.zoom(-0.1)" title="Zoom Out">
                <i class="fas fa-search-minus"></i> Zoom Out
            </button>
            <button class="crop-btn" onclick="cropper.rotate(90)" title="Rotate Right">
                <i class="fas fa-redo"></i> Rotate Right
            </button>
            <button class="crop-btn" onclick="cropper.rotate(-90)" title="Rotate Left">
                <i class="fas fa-undo"></i> Rotate Left
            </button>
            <button class="crop-btn" onclick="cropper.scaleX(-cropper.getData().scaleX || -1)" title="Flip Horizontal">
                <i class="fas fa-arrows-alt-h"></i> Flip H
            </button>
            <button class="crop-btn" onclick="cropper.scaleY(-cropper.getData().scaleY || -1)" title="Flip Vertical">
                <i class="fas fa-arrows-alt-v"></i> Flip V
            </button>
            <button class="crop-btn" onclick="cropper.reset()" title="Reset">
                <i class="fas fa-sync"></i> Reset
            </button>
        </div>
        
        <div class="crop-actions">
            <button class="btn btn-primary" onclick="applyCrop()">
                <i class="fas fa-check"></i> Apply Crop
            </button>
            <button class="btn btn-secondary" onclick="closeCropModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
    let cropper = null;
    let currentFile = null;
    let croppedBlob = null;
    
    function previewImage(input) {
        if (input.files && input.files[0]) {
            currentFile = input.files[0];
            
            // Check file type only
            if (!currentFile.type.match('image.*')) {
                alert('Please select an image file');
                input.value = '';
                return;
            }
            
            // Show loading message for large files
            if (currentFile.size > 10 * 1024 * 1024) {
                console.log('Large image detected, loading may take a moment...');
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                openCropModal(e.target.result);
            };
            reader.readAsDataURL(currentFile);
        }
    }
    
    function openCropModal(imageData) {
        const modal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        
        // Destroy previous cropper instance if exists
        if (cropper) {
            cropper.destroy();
        }
        
        // Set image source
        cropImage.src = imageData;
        
        // Show modal
        modal.classList.add('active');
        
        // Initialize Cropper.js
        cropper = new Cropper(cropImage, {
            aspectRatio: 1, // Square crop for profile images
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            background: false,
            responsive: true,
            checkOrientation: true,
            minContainerWidth: 300,
            minContainerHeight: 300,
        });
    }
    
    function closeCropModal() {
        const modal = document.getElementById('cropModal');
        modal.classList.remove('active');
        
        // Destroy cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        // Clear file input if no crop was applied
        if (!croppedBlob) {
            document.getElementById('profile_image').value = '';
        }
    }
    
    function applyCrop() {
        if (!cropper) return;
        
        // Get cropped canvas with optimized dimensions
        const canvas = cropper.getCroppedCanvas({
            width: 500,  // Output dimensions for profile image
            height: 500,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        // Convert to blob with compression
        // First try with 0.7 quality (good balance)
        compressAndSave(canvas, 0.7);
    }
    
    function compressAndSave(canvas, quality) {
        canvas.toBlob(function(blob) {
            if (!blob) {
                alert('Failed to crop image. Please try again.');
                return;
            }
            
            const sizeInKB = blob.size / 1024;
            const sizeInMB = sizeInKB / 1024;
            
            console.log(`Compressed image size: ${sizeInKB.toFixed(2)} KB (${sizeInMB.toFixed(2)} MB)`);
            console.log(`Compression quality: ${(quality * 100).toFixed(0)}%`);
            
            // If still too large (over 1MB), try more aggressive compression
            if (blob.size > 1024 * 1024 && quality > 0.5) {
                console.log('Image still large, applying more compression...');
                compressAndSave(canvas, quality - 0.1);
                return;
            }
            
            croppedBlob = blob;
            
            // Determine file extension and type based on compression
            const fileName = currentFile.name.replace(/\.[^/.]+$/, '') + '.jpg';
            const fileType = 'image/jpeg';
            
            // Create a new File object from the blob
            const croppedFile = new File([blob], fileName, {
                type: fileType,
                lastModified: Date.now(),
            });
            
            // Update file input with cropped image
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            document.getElementById('profile_image').files = dataTransfer.files;
            
            // Update preview
            const preview = document.getElementById('image-preview');
            const previewURL = canvas.toDataURL('image/jpeg', quality);
            
            if (preview.tagName === 'IMG') {
                preview.src = previewURL;
            } else {
                preview.innerHTML = `<img src="${previewURL}" alt="Profile Preview" class="profile-image-preview">`;
            }
            
            // Close modal
            closeCropModal();
            
            // Show success message with file size
            const finalSizeKB = (blob.size / 1024).toFixed(2);
            alert(`Image cropped and compressed successfully!\nFinal size: ${finalSizeKB} KB\n\nClick "Save Changes" to upload.`);
            
        }, 'image/jpeg', quality);
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('cropModal').classList.contains('active')) {
            closeCropModal();
        }
    });
    
    // Prevent modal background scroll
    document.getElementById('cropModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCropModal();
        }
    });
    
    // Initialize AOS animations
    AOS.init({
        duration: 1000,
        once: true,
        offset: 100
    });
</script>
{% endblock %}

{% extends "admin/admin_base.html" %}

{% block admin_title %}{{ member.full_name }}{% endblock %}
{% block page_title %}Member Details{% endblock %}
{% block breadcrumb %}
<span class="breadcrumb-separator">/</span> 
<a href="{{ url_for('admin.members') }}">Members</a>
<span class="breadcrumb-separator">/</span> 
<span>{{ member.full_name }}</span>
{% endblock %}

{% block admin_content %}
<!-- Member Header -->
<div class="admin-card mb-4">
    <div class="admin-card-body">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                {% if member.profile_image %}
                <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_image) }}" 
                     alt="{{ member.full_name }}" 
                     class="rounded-circle"
                     style="width: 120px; height: 120px; object-fit: cover;">
                {% else %}
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center"
                     style="width: 120px; height: 120px; font-size: 3rem;">
                    <i class="fas fa-user"></i>
                </div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h3>{{ member.full_name }}</h3>
                <p class="mb-2">{{ member.title or 'Member' }}</p>
                <div class="mb-2">
                    <strong>Member ID:</strong> {{ member.member_id_number }}<br>
                    <strong>Email:</strong> {{ member.user.email }}<br>
                    <strong>Phone:</strong> {{ member.phone or 'N/A' }}<br>
                    <strong>Course:</strong> {{ member.course or 'N/A' }} ({{ member.year or 'N/A' }})
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="mb-3">
                    <h4 class="mb-0">{{ total_points }}</h4>
                    <small >Total Points</small>
                </div>
                {% if membership_status == 'valid' %}
                <span class="admin-badge admin-badge-success" style="font-size: 1rem; padding: 8px 16px;">
                    <i class="fas fa-check-circle"></i> Membership Valid
                </span>
                {% elif membership_status == 'expired' %}
                <span class="admin-badge admin-badge-warning" style="font-size: 1rem; padding: 8px 16px;">
                    <i class="fas fa-exclamation-triangle"></i> Membership Expired
                </span>
                {% else %}
                <span class="admin-badge admin-badge-secondary" style="font-size: 1rem; padding: 8px 16px;">
                    <i class="fas fa-minus-circle"></i> No Payment
                </span>
                {% endif %}
            </div>
        </div>
        <div class="mt-3">
            <a href="{{ url_for('admin.add_points', member_id=member.id) }}" class="admin-btn admin-btn-primary">
                <i class="fas fa-plus"></i> Award Points
            </a>
            <a href="{{ url_for('admin.add_payment', member_id=member.id) }}" class="admin-btn admin-btn-success">
                <i class="fas fa-dollar-sign"></i> Record Payment
            </a>
            <a href="{{ url_for('member.profile') }}?member_id={{ member.id }}" class="admin-btn admin-btn-outline">
                <i class="fas fa-id-card"></i> View Public Profile
            </a>
        </div>
    </div>
</div>

<!-- Trophy Showcase -->
{% if trophies %}
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <h5><i class="fas fa-trophy"></i> Earned Trophies ({{ trophies|length }})</h5>
    </div>
    <div class="admin-card-body">
        <div class="row">
            {% for trophy in trophies %}
            <div class="col-md-3 mb-3">
                <div class="text-center p-3 border rounded">
                    <div style="font-size: 3rem;">
                        <i class="{{ trophy.icon }}"></i>
                    </div>
                    <h6 class="mt-2">{{ trophy.name }}</h6>
                    <small >{{ trophy.points_required }} points</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Trophy Progress -->
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <h5><i class="fas fa-chart-line"></i> Trophy Progress</h5>
    </div>
    <div class="admin-card-body">
        {% for trophy in all_trophies %}
        {% set earned = trophy in trophies %}
        {% set progress = (total_points / trophy.points_required * 100) if total_points < trophy.points_required else 100 %}
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span>
                    <i class="{{ trophy.icon }}"></i> {{ trophy.name }}
                    {% if earned %}
                    <span class="admin-badge admin-badge-success">Earned</span>
                    {% endif %}
                </span>
                <small>{{ trophy.points_required }} points</small>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar {% if earned %}bg-success{% else %}bg-primary{% endif %}" 
                     role="progressbar" 
                     style="width: {{ progress }}%">
                    {{ "%.0f"|format(progress) }}%
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#payments">
            <i class="fas fa-dollar-sign"></i> Payment History
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#transactions">
            <i class="fas fa-coins"></i> Point Transactions
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#attendance">
            <i class="fas fa-calendar-check"></i> Event Attendance
        </a>
    </li>
</ul>

<div class="tab-content">
    <!-- Payment History Tab -->
    <div class="tab-pane fade show active" id="payments">
        {% if payments %}
        <div class="admin-table-container">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Payment Date</th>
                            <th>Amount</th>
                            <th>Period</th>
                            <th>Status</th>
                            <th>Method</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                            <td><strong>Tsh {{ "%.2f"|format(payment.amount) }}</strong></td>
                            <td>
                                {{ payment.start_date.strftime('%Y-%m-%d') }} to 
                                {{ payment.end_date.strftime('%Y-%m-%d') }}
                            </td>
                            <td>
                                {% if payment.is_active() %}
                                <span class="admin-badge admin-badge-success">Active</span>
                                {% elif payment.is_expired() %}
                                <span class="admin-badge admin-badge-secondary">Expired</span>
                                {% else %}
                                <span class="admin-badge admin-badge-info">Future</span>
                                {% endif %}
                            </td>
                            <td>{{ payment.payment_method }}</td>
                            <td>
                                <a href="{{ url_for('admin.edit_payment', payment_id=payment.id) }}" 
                                   class="admin-btn admin-btn-sm admin-btn-outline">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-dollar-sign"></i>
            <h5>No payment history</h5>
            <p>No membership payments have been recorded for this member.</p>
            <a href="{{ url_for('admin.add_payment', member_id=member.id) }}" class="admin-btn admin-btn-primary">
                <i class="fas fa-plus"></i> Record First Payment
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Point Transactions Tab -->
    <div class="tab-pane fade" id="transactions">
        {% if recent_transactions %}
        <div class="admin-table-container">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Points</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Admin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in recent_transactions %}
                        <tr>
                            <td>{{ trans.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if trans.points > 0 %}
                                <span class="text-success">+{{ trans.points }}</span>
                                {% else %}
                                <span class="text-danger">{{ trans.points }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="admin-badge admin-badge-info">{{ trans.transaction_type }}</span>
                            </td>
                            <td>{{ trans.reason }}</td>
                            <td>{{ trans.admin.email if trans.admin else 'System' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-coins"></i>
            <h5>No transactions yet</h5>
            <p>No reward points have been awarded to this member.</p>
            <a href="{{ url_for('admin.add_points', member_id=member.id) }}" class="admin-btn admin-btn-primary">
                <i class="fas fa-plus"></i> Award Points
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Attendance Tab -->
    <div class="tab-pane fade" id="attendance">
        {% if attendance %}
        <div class="admin-table-container">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Event Date</th>
                            <th>Check-in Time</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rsvp in attendance %}
                        <tr>
                            <td><strong>{{ rsvp.event.title }}</strong></td>
                            <td>{{ rsvp.event.event_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ rsvp.checked_in_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><span class="admin-badge admin-badge-info">{{ rsvp.event.category }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-calendar-check"></i>
            <h5>No event attendance</h5>
            <p>This member hasn't checked into any events yet.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}


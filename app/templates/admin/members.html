{% extends "admin/admin_base.html" %}

{% block admin_title %}Member Management{% endblock %}
{% block page_title %}Member Management{% endblock %}
{% block breadcrumb %}<span class="breadcrumb-separator">/</span> <span>Members</span>{% endblock %}

{% block admin_content %}
<div class="admin-page-header mb-4">
    <div>
        <h2 class="mb-1">Member Management</h2>
        <p class="mb-0">View and manage all club members with payment tracking</p>
    </div>
    <div>
        <a href="{{ url_for('admin.scan_id') }}" class="admin-btn admin-btn-primary">
            <i class="fas fa-qrcode"></i> Scan Member ID
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="admin-stat-card">
            <h5>{{ total_members }}</h5>
            <p>Total Members</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="admin-stat-card success">
            <h5>{{ valid_count }}</h5>
            <p>Valid Memberships</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="admin-stat-card warning">
            <h5>{{ expired_count }}</h5>
            <p>Expired Memberships</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="admin-stat-card">
            <h5>{{ none_count }}</h5>
            <p>No Payment History</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="admin-stat-card">
            <div class="d-flex align-items-center">
                <i class="fas fa-crown text-warning me-2"></i>
                <div>
                    <h5>{{ super_admin_count }}</h5>
                    <p>Super Admins</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="admin-stat-card">
            <div class="d-flex align-items-center">
                <i class="fas fa-user-shield text-primary me-2"></i>
                <div>
                    <h5>{{ admin_count }}</h5>
                    <p>Admins</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="admin-card mb-4">
    <div class="admin-card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Name, ID, or Email" value="{{ search_query }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Payment Status</label>
                <select name="status" class="form-control">
                    <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Status</option>
                    <option value="valid" {% if current_status == 'valid' %}selected{% endif %}>Valid</option>
                    <option value="expired" {% if current_status == 'expired' %}selected{% endif %}>Expired</option>
                    <option value="none" {% if current_status == 'none' %}selected{% endif %}>No Payments</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Role</label>
                <select name="role" class="form-control">
                    <option value="all" {% if current_role == 'all' %}selected{% endif %}>All Roles</option>
                    <option value="admin" {% if current_role == 'admin' %}selected{% endif %}>Admins</option>
                    <option value="member" {% if current_role == 'member' %}selected{% endif %}>Regular Members</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Course</label>
                <select name="course" class="form-control">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {% if current_course == course %}selected{% endif %}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Year</label>
                <select name="year" class="form-control">
                    <option value="">All Years</option>
                    {% for year in years %}
                    <option value="{{ year }}" {% if current_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="admin-btn admin-btn-primary me-2">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{{ url_for('admin.members') }}" class="admin-btn admin-btn-outline">
                    <i class="fas fa-redo"></i> Reset
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Download Section -->
<div class="admin-card mb-4">
    <div class="admin-card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">
                    <i class="fas fa-download me-2"></i>
                    Download Reports
                </h5>
                <p class="mb-0">Export member data as CSV files</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('admin.export_members', report_type='all_users') }}" 
                   class="admin-btn admin-btn-success">
                    <i class="fas fa-file-csv me-1"></i>
                    Download All Users
                </a>
                <a href="{{ url_for('admin.export_members', report_type='all_members') }}" 
                   class="admin-btn admin-btn-primary">
                    <i class="fas fa-file-csv me-1"></i>
                    Download All Members
                </a>
                <a href="{{ url_for('admin.export_members', report_type='filtered', status=current_status, role=current_role, search=search_query, course=current_course, year=current_year) }}" 
                   class="admin-btn admin-btn-info">
                    <i class="fas fa-file-csv me-1"></i>
                    Download Filtered Results
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Members Table -->
{% if members %}
<div class="admin-table-container">
    <div class="admin-table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>Member ID</th>
                    <th>Course & Year</th>
                    <th>Role</th>
                    <th>Points</th>
                    <th>Membership Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for member in members %}
                {% set status = member.get_membership_status() %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if member.profile_image %}
                            <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_image) }}" 
                                 alt="{{ member.full_name }}" 
                                 class="rounded-circle me-3"
                                 style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                            <div class="admin-activity-icon primary me-3">
                                <i class="fas fa-user"></i>
                            </div>
                            {% endif %}
                            <div>
                                <h6 class="mb-0">{{ member.full_name }}</h6>
                                <small >{{ member.user.email }}</small>
                            </div>
                        </div>
                    </td>
                    <td><strong>{{ member.member_id_number }}</strong></td>
                    <td>
                        {{ member.course or 'N/A' }}<br>
                        <small >{{ member.year or 'N/A' }}</small>
                    </td>
                    <td>
                        {% if member.user.is_super_admin %}
                        <span class="admin-badge admin-badge-warning">
                            <i class="fas fa-crown"></i> Super Admin
                        </span>
                        {% elif member.user.role == 'admin' %}
                        <span class="admin-badge admin-badge-primary">
                            <i class="fas fa-user-shield"></i> Admin
                        </span>
                        {% else %}
                        <span class="admin-badge admin-badge-secondary">
                            <i class="fas fa-user"></i> Member
                        </span>
                        {% endif %}
                    </td>
                    <td><span class="admin-badge admin-badge-info">{{ member.get_total_points() }} pts</span></td>
                    <td>
                        {% if status == 'valid' %}
                        <span class="admin-badge admin-badge-success">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                        {% elif status == 'expired' %}
                        <span class="admin-badge admin-badge-warning">
                            <i class="fas fa-exclamation-triangle"></i> Expired
                        </span>
                        {% else %}
                        <span class="admin-badge admin-badge-secondary">
                            <i class="fas fa-minus-circle"></i> No Payment
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="{{ url_for('admin.member_detail', member_id=member.id) }}" 
                               class="admin-btn admin-btn-sm admin-btn-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <a href="{{ url_for('admin.add_payment', member_id=member.id) }}" 
                               class="admin-btn admin-btn-sm admin-btn-success">
                                <i class="fas fa-dollar-sign"></i> Add Payment
                            </a>
                            <a href="{{ url_for('admin.add_points', member_id=member.id) }}" 
                               class="admin-btn admin-btn-sm admin-btn-info">
                                <i class="fas fa-plus"></i> Add Points
                            </a>
                            {% if member.user.role != 'admin' %}
                            <form method="POST" action="{{ url_for('admin.promote_member', member_id=member.id) }}" class="d-inline">
                                <button type="submit" class="admin-btn admin-btn-sm admin-btn-warning" 
                                        onclick="return confirm('Promote {{ member.full_name }} to admin?')">
                                    <i class="fas fa-user-shield"></i> Make Admin
                                </button>
                            </form>
                            {% elif not member.user.is_super_admin %}
                            <form method="POST" action="{{ url_for('admin.demote_member', member_id=member.id) }}" class="d-inline">
                                <button type="submit" class="admin-btn admin-btn-sm admin-btn-secondary" 
                                        onclick="return confirm('Demote {{ member.full_name }} to regular member?')">
                                    <i class="fas fa-user"></i> Revoke Admin
                                </button>
                            </form>
                            {% else %}
                            <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" disabled 
                                    title="Cannot demote super admin">
                                <i class="fas fa-crown"></i> Super Admin
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="admin-empty-state">
    <i class="fas fa-users"></i>
    <h5>No members found</h5>
    <p>Try adjusting your filters or search criteria.</p>
</div>
{% endif %}
{% endblock %}


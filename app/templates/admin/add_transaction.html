{% extends "admin/admin_base.html" %}

{% block admin_title %}Add Transaction{% endblock %}
{% block page_title %}Add Transaction{% endblock %}
{% block breadcrumb %}<span class="breadcrumb-separator">/</span> <a href="{{ url_for('admin.financial') }}">Financial Management</a><span class="breadcrumb-separator">/</span> <a href="{{ url_for('admin.financial_period_detail', period_id=period.id) }}">{{ period.name }}</a><span class="breadcrumb-separator">/</span> <span>Add Transaction</span>{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Add Transaction</h2>
        <p class="mb-0">Record a new financial transaction for {{ period.name }}</p>
    </div>
    <div>
        <a href="{{ url_for('admin.financial_period_detail', period_id=period.id) }}" class="admin-btn admin-btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Period
        </a>
    </div>
</div>

<!-- Period Info -->
<div class="admin-card mb-4">
    <div class="admin-card-body">
        <div class="d-flex align-items-center">
            <div class="admin-alert-icon info">
                <i class="fas fa-calendar"></i>
            </div>
            <div class="flex-grow-1">
                <h5 class="mb-1">{{ period.name }}</h5>
                <p >
                    {{ period.start_date.strftime('%B %d, %Y') }} - {{ period.end_date.strftime('%B %d, %Y') }}
                    {% if period.description %} | {{ period.description }}{% endif %}
                </p>
            </div>
            <div>
                <span class="admin-badge admin-badge-success">Open</span>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Form -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5><i class="fas fa-plus"></i> Transaction Details</h5>
    </div>
    <div class="admin-card-body">
        <form method="POST">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="transaction_type" class="form-label">Transaction Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="transaction_type" name="transaction_type" required>
                            <option value="">Select Type</option>
                            <option value="revenue">Revenue (Money Coming In)</option>
                            <option value="expense">Expense (Money Going Out)</option>
                        </select>
                        <div class="form-text">Choose whether this is money coming in or going out.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-control" id="category_id" name="category_id" required disabled>
                            <option value="">Select Transaction Type First</option>
                        </select>
                        <div class="form-text">Choose the appropriate category for this transaction.</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">Tsh </span>
                            <input type="number" class="form-control" id="amount" name="amount" 
                                   step="0.01" min="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-text">Enter the transaction amount (must be greater than Tsh 0).</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="transaction_date" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="transaction_date" name="transaction_date" required>
                        <div class="form-text">When this transaction occurred.</div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="description" name="description" required
                       placeholder="Brief description of the transaction">
                <div class="form-text">Provide a clear description of what this transaction is for.</div>
            </div>
            
            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3"
                          placeholder="Additional details, reference numbers, or context"></textarea>
                <div class="form-text">Optional additional information about this transaction.</div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin.financial_period_detail', period_id=period.id) }}" class="admin-btn admin-btn-outline">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="admin-btn admin-btn-primary">
                    <i class="fas fa-plus"></i> Add Transaction
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Examples -->
<div class="admin-card mt-4">
    <div class="admin-card-header">
        <h5><i class="fas fa-lightbulb"></i> Transaction Examples</h5>
    </div>
    <div class="admin-card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-success">Revenue Examples:</h6>
                <ul class="mb-0">
                    <li><strong>Membership Fees:</strong> Annual membership payments from members</li>
                    <li><strong>Event Revenue:</strong> Ticket sales, workshop fees, hackathon entry fees</li>
                    <li><strong>Sponsorships:</strong> Corporate sponsorships and donations</li>
                    <li><strong>Donations:</strong> Alumni donations or external funding</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="text-danger">Expense Examples:</h6>
                <ul class="mb-0">
                    <li><strong>Equipment:</strong> Laptops, projectors, development tools</li>
                    <li><strong>Venue Costs:</strong> Room rentals, event spaces</li>
                    <li><strong>Event Costs:</strong> Catering, materials, prizes</li>
                    <li><strong>Marketing:</strong> Flyers, banners, promotional materials</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
.admin-alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.admin-alert-icon.info {
    background: rgba(0, 255, 255, 0.2);
    color: #00ffff;
}

.input-group-text {
    background-color: #16213e;
    color: #ffffff;
    border-color: rgba(0, 255, 255, 0.2);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('transaction_type');
    const categorySelect = document.getElementById('category_id');
    const amountInput = document.getElementById('amount');
    const transactionDateInput = document.getElementById('transaction_date');
    
    // Set default transaction date to today
    const today = new Date().toISOString().split('T')[0];
    transactionDateInput.value = today;
    
    // Categories data
    const categories = {
        revenue: [
            {% for category in categories %}
            {% if category.type == 'revenue' %}
            {id: {{ category.id }}, name: "{{ category.name }}"},
            {% endif %}
            {% endfor %}
        ],
        expense: [
            {% for category in categories %}
            {% if category.type == 'expense' %}
            {id: {{ category.id }}, name: "{{ category.name }}"},
            {% endif %}
            {% endfor %}
        ]
    };
    
    // Update categories when transaction type changes
    transactionTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Clear and disable category select
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        categorySelect.disabled = true;
        
        if (selectedType && categories[selectedType]) {
            // Populate categories for selected type
            categories[selectedType].forEach(function(category) {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            // Enable category select
            categorySelect.disabled = false;
        }
    });
    
    // Format amount input
    amountInput.addEventListener('input', function() {
        // Ensure positive values
        if (this.value < 0) {
            this.value = 0;
        }
    });
    
    // Validate form before submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const transactionType = transactionTypeSelect.value;
        const categoryId = categorySelect.value;
        const amount = parseFloat(amountInput.value);
        const description = document.getElementById('description').value.trim();
        
        if (!transactionType) {
            e.preventDefault();
            alert('Please select a transaction type.');
            return;
        }
        
        if (!categoryId) {
            e.preventDefault();
            alert('Please select a category.');
            return;
        }
        
        if (!amount || amount <= 0) {
            e.preventDefault();
            alert('Please enter a valid amount greater than Tsh 0.');
            return;
        }
        
        if (!description) {
            e.preventDefault();
            alert('Please enter a description.');
            return;
        }
    });
});
</script>
{% endblock %}
